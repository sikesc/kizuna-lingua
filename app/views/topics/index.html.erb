<%= turbo_stream_from "topics" %>
<div class="topics-index-container">
  <div class="topics-header">
    <h2>Explore topics</h2>
    <button type="button" class="create-topic-btn" data-bs-toggle="modal" data-bs-target="#newTopicModal">
      New topic
    </button>
  </div>

  <div class="topics-search-container" id="search-container" data-turbo-permanent>
    <%= simple_form_for :search, url: topics_path, method: :get, html: { class: "d-flex", data: { controller: "search-form", turbo_frame: "topics_list" } } do |f| %>
      <%= f.input :query, label: false, wrapper: false, input_html: {class: "form-control", placeholder: "Search topics...", value: params[:search].try(:[], :query), data: { action: "input->search-form#submit" }} %>
    <% end %>
  </div>

  <div class="topics-filter-container">
    <%= link_to "All", topics_path(status: nil, search: params[:search]), class: "filter-btn #{'active' if params[:status].blank?}" %>
    <%= link_to "Not Started", topics_path(status: "not_started", search: params[:search]), class: "filter-btn #{'active' if params[:status] == 'not_started'}" %>
    <%= link_to "In Progress", topics_path(status: "in_progress", search: params[:search]), class: "filter-btn #{'active' if params[:status] == 'in_progress'}" %>
    <%= link_to "Completed", topics_path(status: "completed", search: params[:search]), class: "filter-btn #{'active' if params[:status] == 'completed'}" %>
  </div>

  <ul class="topics-list" id="topics-list">
    <% @topics.each do |topic| %>
      <% content_to_display = if current_user.learning_language == "japanese"
                                topic.content["eng"]
                              else
                                topic.content["jpn"]
                              end %>
      <% topic_status = @topic_statuses[topic.id]&.status || "not started" %>
      <%= render "topics/topic", topic: topic, content_to_display: content_to_display, partnership_topic: @partnership_topic, topic_status: topic_status %>
    <% end %>
  </ul>
</div>

<%# New Topic Modal %>
<div class="modal fade topic-modal" id="newTopicModal" tabindex="-1" aria-labelledby="newTopicModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTopicModalLabel">Generate a New Topic</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= simple_form_for :topic, url: generate_topics_path, method: :post, 'data-turbo': false do |f| %>
          <%= f.input :name, label: "Suggest a Topic Title:", placeholder: "e.g., 'Planning a Trip', 'Favorite Books'", required: true %>
          <div class="modal-footer">
            <%= f.button :submit, "Generate Topic", class: "generate-topic-btn", data: { disable_with: "Generating..." } %>
            <button type="button" class="close-topic-btn" data-bs-dismiss="modal">Close</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
