<div class="dashboard">
  <!-- Header Section -->
  <header class="dashboard-header">
    <div class="dashboard-header__greeting">
      <div class="dashboard-header__welcome">
        <h1>Welcome back, <%= current_user.name.split.first %></h1>
        <p>Continue your language journey</p>
      </div>
      <div class="dashboard-header__avatars">
        <div class="partnership-link">
          <% if current_user.photo.attached? %>
            <%= cl_image_tag current_user.photo.key, class: "avatar avatar--user", alt: "Your avatar" %>
          <% else %>
            <%= image_tag "user.png", class: "avatar avatar--user", alt: "Your avatar" %>
          <% end %>
          <% if @partner.photo.attached? %>
            <%= cl_image_tag @partner.photo.key, class: "avatar avatar--partner", alt: "#{@partner.name}'s avatar" %>
          <% else %>
            <%= image_tag "user.png", class: "avatar avatar--partner", alt: "Partner avatar" %>
          <% end %>
        </div>
      </div>
    </div>
  </header>

  <main class="dashboard__main">
    <% if @most_recent_topic %>
      <!-- Topic Progress Card -->
      <section class="dashboard-section">
        <div class="topic-progress-card">
          <%= link_to topic_path(@most_recent_topic), class: "topic-progress-card__link" do %>
            <div class="topic-progress-card__hero">
              <% if @most_recent_topic.image.attached? %>
                <%= image_tag url_for(@most_recent_topic.image), class: "topic-progress-card__image", alt: @most_recent_topic.name %>
              <% else %>
                <%= image_tag "https://images.unsplash.com/photo-1517673132405-a56a62b18caf?q=80&w=1176&auto=format&fit=crop", class: "topic-progress-card__image", alt: @most_recent_topic.name %>
              <% end %>
              <div class="topic-progress-card__overlay">
                <div class="topic-progress-card__info">
                  <span class="topic-progress-card__label">Current Topic</span>
                  <h2 class="topic-progress-card__name"><%= @most_recent_topic.name %></h2>
                </div>
                <div class="topic-progress-card__ring">
                  <% circumference = 2 * Math::PI * 25 %>
                  <% offset = circumference - (@progress_percentage / 100.0) * circumference %>
                  <div class="circular-progress">
                    <svg viewBox="0 0 60 60">
                      <circle class="circular-progress__bg" cx="30" cy="30" r="25"/>
                      <circle class="circular-progress__fill" cx="30" cy="30" r="25"
                        stroke-dasharray="<%= circumference %>"
                        stroke-dashoffset="<%= offset %>"/>
                    </svg>
                    <span class="circular-progress__text"><%= @progress_percentage.round %>%</span>
                  </div>
                </div>
              </div>
            </div>
          <% end %>

          <div class="topic-progress-card__actions">
            <% if @progress_percentage >= 100 %>
              <%= button_to 'Complete Topic',
                complete_topic_partnership_topic_path(@most_recent),
                method: :patch,
                data: { confirm: 'Are you sure you want to finish this topic?' },
                class: 'topic-action-btn topic-action-btn--complete' %>
            <% end %>
            <%= link_to topics_path, class: "topic-action-btn topic-action-btn--change" do %>
              <i class="fas fa-exchange-alt"></i>
              Change Topic
            <% end %>
          </div>
        </div>
      </section>

      <!-- Progress Section -->
      <section class="dashboard-section">
        <div class="dashboard-section__header">
          <h3 class="dashboard-section__title">Your Progress</h3>
        </div>

        <div class="progress-grid">
          <!-- Your Tasks Column -->
          <div class="progress-column">
            <div class="progress-column__header">
              <% if current_user.photo.attached? %>
                <%= cl_image_tag current_user.photo.key, class: "progress-column__avatar", alt: "You" %>
              <% else %>
                <%= image_tag "user.png", class: "progress-column__avatar", alt: "You" %>
              <% end %>
              <div>
                <h4 class="progress-column__title">Your Tasks</h4>
                <p class="progress-column__subtitle">Complete these to progress</p>
              </div>
            </div>

            <div class="task-list">
              <!-- Journal Entry -->
              <% if @my_journal %>
                <%= link_to partnership_journal_path(@partnership, @my_journal), class: "task-item task-item--clickable" do %>
                  <div class="task-item__icon task-item__icon--journal">
                    <i class="fas fa-book"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title">Journal Entry</p>
                    <p class="task-item__subtitle">Your writing practice</p>
                  </div>
                  <div class="task-item__status task-item__status--complete">
                    <i class="fas fa-check-circle"></i>
                  </div>
                <% end %>
              <% else %>
                <%= link_to topic_path(@most_recent_topic), class: "task-item task-item--clickable" do %>
                  <div class="task-item__icon task-item__icon--journal">
                    <i class="fas fa-book"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title">Journal Entry</p>
                    <p class="task-item__subtitle">Write your entry</p>
                  </div>
                  <div class="task-item__status task-item__status--incomplete">
                    <i class="fas fa-circle"></i>
                  </div>
                <% end %>
              <% end %>

              <!-- Partner Guidance (Feedback to partner) -->
              <% if @partner_journal %>
                <% if @partner_journal.feedback %>
                  <%= link_to partnership_journal_path(@partnership, @partner_journal), class: "task-item task-item--clickable" do %>
                    <div class="task-item__icon task-item__icon--feedback">
                      <i class="fas fa-comments"></i>
                    </div>
                    <div class="task-item__content">
                      <p class="task-item__title">Partner Guidance</p>
                      <p class="task-item__subtitle">Feedback provided</p>
                    </div>
                    <div class="task-item__status task-item__status--complete">
                      <i class="fas fa-check-circle"></i>
                    </div>
                  <% end %>
                <% else %>
                  <%= link_to partnership_journal_path(@partnership, @partner_journal), class: "task-item task-item--clickable" do %>
                    <div class="task-item__icon task-item__icon--feedback">
                      <i class="fas fa-comments"></i>
                    </div>
                    <div class="task-item__content">
                      <p class="task-item__title">Partner Guidance</p>
                      <p class="task-item__subtitle">Help your partner improve</p>
                    </div>
                    <div class="task-item__status task-item__status--incomplete">
                      <i class="fas fa-circle"></i>
                    </div>
                  <% end %>
                <% end %>
              <% else %>
                <div class="task-item task-item--disabled">
                  <div class="task-item__icon task-item__icon--feedback">
                    <i class="fas fa-comments"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title">Partner Guidance</p>
                    <p class="task-item__subtitle">Waiting for partner's journal</p>
                  </div>
                  <div class="task-item__status task-item__status--locked">
                    <i class="fas fa-lock"></i>
                  </div>
                </div>
              <% end %>

              <!-- Conversation -->
              <% if @my_journal && @partner_journal %>
                <% if @my_journal.conversation_status %>
                  <div class="task-item">
                    <div class="task-item__icon task-item__icon--conversation">
                      <i class="fas fa-microphone"></i>
                    </div>
                    <div class="task-item__content">
                      <p class="task-item__title">Conversation</p>
                      <p class="task-item__subtitle">Practice complete</p>
                    </div>
                    <div class="task-item__status task-item__status--complete">
                      <i class="fas fa-check-circle"></i>
                    </div>
                  </div>
                <% else %>
                  <%= link_to challenge_path(@challenge), class: "task-item task-item--clickable" do %>
                    <div class="task-item__icon task-item__icon--conversation">
                      <i class="fas fa-microphone"></i>
                    </div>
                    <div class="task-item__content">
                      <p class="task-item__title">Conversation</p>
                      <p class="task-item__subtitle">Practice speaking</p>
                    </div>
                    <div class="task-item__status task-item__status--incomplete">
                      <i class="fas fa-circle"></i>
                    </div>
                  <% end %>
                <% end %>
              <% else %>
                <div class="task-item task-item--disabled">
                  <div class="task-item__icon task-item__icon--conversation">
                    <i class="fas fa-microphone"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title">Conversation</p>
                    <p class="task-item__subtitle">Complete journals first</p>
                  </div>
                  <div class="task-item__status task-item__status--locked">
                    <i class="fas fa-lock"></i>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Partner's Tasks Column -->
          <div class="progress-column">
            <div class="progress-column__header">
              <% if @partner.photo.attached? %>
                <%= cl_image_tag @partner.photo.key, class: "progress-column__avatar", alt: @partner.name %>
              <% else %>
                <%= image_tag "user.png", class: "progress-column__avatar", alt: @partner.name %>
              <% end %>
              <div>
                <h4 class="progress-column__title"><%= @partner.name.split.first %>'s Tasks</h4>
                <p class="progress-column__subtitle">Partner progress</p>
              </div>
            </div>

            <div class="task-list">
              <!-- Partner's Journal -->
              <div class="task-item">
                <div class="task-item__icon task-item__icon--journal">
                  <i class="fas fa-book"></i>
                </div>
                <div class="task-item__content">
                  <p class="task-item__title">Journal Entry</p>
                  <p class="task-item__subtitle"><%= @partner_journal ? "Entry submitted" : "Not yet written" %></p>
                </div>
                <div class="task-item__status <%= @partner_journal ? 'task-item__status--complete' : 'task-item__status--incomplete' %>">
                  <i class="fas <%= @partner_journal ? 'fa-check-circle' : 'fa-circle' %>"></i>
                </div>
              </div>

              <!-- Feedback from Partner -->
              <% if @my_journal %>
                <div class="task-item">
                  <div class="task-item__icon task-item__icon--feedback">
                    <i class="fas fa-comments"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title">Your Feedback</p>
                    <p class="task-item__subtitle"><%= @my_journal.feedback ? "Feedback received" : "Awaiting feedback" %></p>
                  </div>
                  <div class="task-item__status <%= @my_journal.feedback ? 'task-item__status--complete' : 'task-item__status--incomplete' %>">
                    <i class="fas <%= @my_journal.feedback ? 'fa-check-circle' : 'fa-circle' %>"></i>
                  </div>
                </div>
              <% else %>
                <div class="task-item task-item--disabled">
                  <div class="task-item__icon task-item__icon--feedback">
                    <i class="fas fa-comments"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title">Your Feedback</p>
                    <p class="task-item__subtitle">Write journal first</p>
                  </div>
                  <div class="task-item__status task-item__status--locked">
                    <i class="fas fa-lock"></i>
                  </div>
                </div>
              <% end %>

              <!-- Partner's Conversation Status -->
              <% if @my_journal && @partner_journal %>
                <div class="task-item">
                  <div class="task-item__icon task-item__icon--conversation">
                    <i class="fas fa-microphone"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title">Conversation</p>
                    <p class="task-item__subtitle"><%= @my_journal.conversation_status ? "Completed together" : "Ready to practice" %></p>
                  </div>
                  <div class="task-item__status <%= @my_journal.conversation_status ? 'task-item__status--complete' : 'task-item__status--incomplete' %>">
                    <i class="fas <%= @my_journal.conversation_status ? 'fa-check-circle' : 'fa-circle' %>"></i>
                  </div>
                </div>
              <% else %>
                <div class="task-item task-item--disabled">
                  <div class="task-item__icon task-item__icon--conversation">
                    <i class="fas fa-microphone"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title">Conversation</p>
                    <p class="task-item__subtitle">Complete journals first</p>
                  </div>
                  <div class="task-item__status task-item__status--locked">
                    <i class="fas fa-lock"></i>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>


    <% else %>
      <!-- Welcome State (No Topic Selected) -->
      <section class="dashboard-section">
        <div class="welcome-card">
          <div class="welcome-card__logo">
            <i class="fas fa-language"></i>
          </div>
          <h2 class="welcome-card__title">Welcome to Kizuna Lingua</h2>
          <p class="welcome-card__text">Start your language learning journey by choosing a topic to explore with your partner.</p>
          <%= link_to topics_path, class: "welcome-card__cta" do %>
            <i class="fas fa-rocket"></i>
            Choose a Topic
          <% end %>
        </div>
      </section>
    <% end %>
  </main>
</div>
