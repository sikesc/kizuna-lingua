<div class="dashboard">
  <!-- Header Section -->
  <header class="dashboard-header">
    <div class="dashboard-header__greeting">
      <div class="dashboard-header__welcome">
        <h1><%= t('dashboard.welcome_back', name: current_user.name.split.first) %></h1>
        <p><%= t('dashboard.continue_journey') %></p>
      </div>
      <div class="dashboard-header__avatars">
        <div class="partnership-link">
          <% if current_user.photo.attached? %>
            <%= cl_image_tag current_user.photo.key, class: "avatar avatar--user", alt: t('alt.your_avatar') %>
          <% else %>
            <%= image_tag "user.png", class: "avatar avatar--user", alt: t('alt.your_avatar') %>
          <% end %>
          <% if @partner.photo.attached? %>
            <%= cl_image_tag @partner.photo.key, class: "avatar avatar--partner", alt: t('alt.partner_avatar', name: @partner.name) %>
          <% else %>
            <%= image_tag "user.png", class: "avatar avatar--partner", alt: t('alt.partner_avatar', name: @partner.name) %>
          <% end %>
        </div>
      </div>
    </div>
  </header>

  <main class="dashboard__main">
    <% if @most_recent_topic %>
      <!-- Topic Progress Card -->
      <section class="dashboard-section">
        <div class="topic-progress-card">
          <%= link_to topic_path(@most_recent_topic), class: "topic-progress-card__link" do %>
            <div class="topic-progress-card__hero">
              <% if @most_recent_topic.image.attached? %>
                <%= image_tag url_for(@most_recent_topic.image), class: "topic-progress-card__image", alt: @most_recent_topic.name %>
              <% else %>
                <%= image_tag "https://images.unsplash.com/photo-1517673132405-a56a62b18caf?q=80&w=1176&auto=format&fit=crop", class: "topic-progress-card__image", alt: @most_recent_topic.name %>
              <% end %>
              <div class="topic-progress-card__overlay">
                <div class="topic-progress-card__info">
                  <span class="topic-progress-card__label"><%= t('dashboard.current_topic') %></span>
                  <h2 class="topic-progress-card__name"><%= @most_recent_topic.name %></h2>
                </div>
                <div class="topic-progress-card__ring">
                  <% circumference = 2 * Math::PI * 25 %>
                  <% offset = circumference - (@progress_percentage / 100.0) * circumference %>
                  <div class="circular-progress">
                    <svg viewBox="0 0 60 60">
                      <circle class="circular-progress__bg" cx="30" cy="30" r="25"/>
                      <circle class="circular-progress__fill" cx="30" cy="30" r="25"
                        stroke-dasharray="<%= circumference %>"
                        stroke-dashoffset="<%= offset %>"/>
                    </svg>
                    <span class="circular-progress__text"><%= @progress_percentage.round %>%</span>
                  </div>
                </div>
              </div>
            </div>
          <% end %>

          <div class="topic-progress-card__actions">
            <% if @progress_percentage >= 100 %>
              <%= button_to t('dashboard.complete_topic'),
                complete_topic_partnership_topic_path(@most_recent),
                method: :patch,
                data: { confirm: t('dashboard.complete_topic_confirm') },
                class: 'topic-action-btn topic-action-btn--complete' %>
            <% end %>
            <%= link_to topics_path, class: "topic-action-btn topic-action-btn--change" do %>
              <i class="fas fa-exchange-alt"></i>
              <%= t('dashboard.change_topic') %>
            <% end %>
          </div>
        </div>
      </section>

      <!-- Progress Section -->
      <section class="dashboard-section">
        <div class="dashboard-section__header">
          <h3 class="dashboard-section__title"><%= t('dashboard.your_progress') %></h3>
        </div>

        <div class="progress-grid">
          <!-- Your Tasks Column -->
          <div class="progress-column">
            <div class="progress-column__header">
              <% if current_user.photo.attached? %>
                <%= cl_image_tag current_user.photo.key, class: "progress-column__avatar", alt: "You" %>
              <% else %>
                <%= image_tag "user.png", class: "progress-column__avatar", alt: "You" %>
              <% end %>
              <div>
                <h4 class="progress-column__title"><%= t('dashboard.your_tasks') %></h4>
                <p class="progress-column__subtitle"><%= t('dashboard.complete_to_progress') %></p>
              </div>
            </div>

            <div class="task-list">
              <!-- Journal Entry -->
              <% if @my_journal %>
                <%= link_to partnership_journal_path(@partnership, @my_journal), class: "task-item task-item--clickable" do %>
                  <div class="task-item__icon task-item__icon--journal">
                    <i class="fas fa-book"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title"><%= t('dashboard.tasks.journal_entry') %></p>
                    <p class="task-item__subtitle"><%= t('dashboard.tasks.your_writing') %></p>
                  </div>
                  <div class="task-item__status task-item__status--complete">
                    <i class="fas fa-check-circle"></i>
                  </div>
                <% end %>
              <% else %>
                <%= link_to topic_path(@most_recent_topic), class: "task-item task-item--clickable" do %>
                  <div class="task-item__icon task-item__icon--journal">
                    <i class="fas fa-book"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title"><%= t('dashboard.tasks.journal_entry') %></p>
                    <p class="task-item__subtitle"><%= t('dashboard.tasks.write_entry') %></p>
                  </div>
                  <div class="task-item__status task-item__status--incomplete">
                    <i class="fas fa-hourglass-half"></i>
                  </div>
                <% end %>
              <% end %>

              <!-- Partner Guidance (Feedback to partner) -->
              <% if @partner_journal %>
                <% if @partner_journal.feedback %>
                  <%= link_to partnership_journal_path(@partnership, @partner_journal), class: "task-item task-item--clickable" do %>
                    <div class="task-item__icon task-item__icon--feedback">
                      <i class="fas fa-comments"></i>
                    </div>
                    <div class="task-item__content">
                      <p class="task-item__title"><%= t('dashboard.tasks.partner_guidance') %></p>
                      <p class="task-item__subtitle"><%= t('dashboard.tasks.feedback_provided') %></p>
                    </div>
                    <div class="task-item__status task-item__status--complete">
                      <i class="fas fa-check-circle"></i>
                    </div>
                  <% end %>
                <% else %>
                  <%= link_to partnership_journal_path(@partnership, @partner_journal), class: "task-item task-item--clickable" do %>
                    <div class="task-item__icon task-item__icon--feedback">
                      <i class="fas fa-comments"></i>
                    </div>
                    <div class="task-item__content">
                      <p class="task-item__title"><%= t('dashboard.tasks.partner_guidance') %></p>
                      <p class="task-item__subtitle"><%= t('dashboard.tasks.help_partner') %></p>
                    </div>
                    <div class="task-item__status task-item__status--incomplete">
                      <i class="fas fa-hourglass-half"></i>
                    </div>
                  <% end %>
                <% end %>
              <% else %>
                <div class="task-item task-item--disabled">
                  <div class="task-item__icon task-item__icon--feedback">
                    <i class="fas fa-comments"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title"><%= t('dashboard.tasks.partner_guidance') %></p>
                    <p class="task-item__subtitle"><%= t('dashboard.tasks.waiting_partner_journal') %></p>
                  </div>
                  <div class="task-item__status task-item__status--locked">
                    <i class="fas fa-lock"></i>
                  </div>
                </div>
              <% end %>

              <!-- Conversation -->
              <% if @my_journal && @partner_journal %>
                <% if @my_journal.conversation_status %>
                  <div class="task-item">
                    <div class="task-item__icon task-item__icon--conversation">
                      <i class="fas fa-microphone"></i>
                    </div>
                    <div class="task-item__content">
                      <p class="task-item__title"><%= t('dashboard.tasks.conversation') %></p>
                      <p class="task-item__subtitle"><%= t('dashboard.tasks.practice_complete') %></p>
                    </div>
                    <div class="task-item__status task-item__status--complete">
                      <i class="fas fa-check-circle"></i>
                    </div>
                  </div>
                <% else %>
                  <%= link_to challenge_path(@challenge), class: "task-item task-item--clickable" do %>
                    <div class="task-item__icon task-item__icon--conversation">
                      <i class="fas fa-microphone"></i>
                    </div>
                    <div class="task-item__content">
                      <p class="task-item__title"><%= t('dashboard.tasks.conversation') %></p>
                      <p class="task-item__subtitle"><%= t('dashboard.tasks.practice_speaking') %></p>
                    </div>
                    <div class="task-item__status task-item__status--incomplete">
                      <i class="fas fa-hourglass-half"></i>
                    </div>
                  <% end %>
                <% end %>
              <% else %>
                <div class="task-item task-item--disabled">
                  <div class="task-item__icon task-item__icon--conversation">
                    <i class="fas fa-microphone"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title"><%= t('dashboard.tasks.conversation') %></p>
                    <p class="task-item__subtitle"><%= t('dashboard.tasks.complete_journals_first') %></p>
                  </div>
                  <div class="task-item__status task-item__status--locked">
                    <i class="fas fa-lock"></i>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Partner's Tasks Column -->
          <div class="progress-column">
            <div class="progress-column__header">
              <% if @partner.photo.attached? %>
                <%= cl_image_tag @partner.photo.key, class: "progress-column__avatar", alt: @partner.name %>
              <% else %>
                <%= image_tag "user.png", class: "progress-column__avatar", alt: @partner.name %>
              <% end %>
              <div>
                <h4 class="progress-column__title"><%= t('dashboard.partner_tasks', name: @partner.name.split.first) %></h4>
                <p class="progress-column__subtitle"><%= t('dashboard.partner_progress') %></p>
              </div>
            </div>

            <div class="task-list">
              <!-- Partner's Journal -->
              <div class="task-item">
                <div class="task-item__icon task-item__icon--journal">
                  <i class="fas fa-book"></i>
                </div>
                <div class="task-item__content">
                  <p class="task-item__title"><%= t('dashboard.tasks.journal_entry') %></p>
                  <p class="task-item__subtitle"><%= @partner_journal ? t('dashboard.tasks.entry_submitted') : t('dashboard.tasks.not_yet_written') %></p>
                </div>
                <div class="task-item__status <%= @partner_journal ? 'task-item__status--complete' : 'task-item__status--incomplete' %>">
                  <i class="fas <%= @partner_journal ? 'fa-check-circle' : 'fa-hourglass-half' %>"></i>
                </div>
              </div>

              <!-- Feedback from Partner -->
              <% if @my_journal %>
                <div class="task-item">
                  <div class="task-item__icon task-item__icon--feedback">
                    <i class="fas fa-comments"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title"><%= t('dashboard.tasks.your_feedback') %></p>
                    <p class="task-item__subtitle"><%= @my_journal.feedback ? t('dashboard.tasks.feedback_received') : t('dashboard.tasks.awaiting_feedback') %></p>
                  </div>
                  <div class="task-item__status <%= @my_journal.feedback ? 'task-item__status--complete' : 'task-item__status--incomplete' %>">
                    <i class="fas <%= @my_journal.feedback ? 'fa-check-circle' : 'fa-hourglass-half' %>"></i>
                  </div>
                </div>
              <% else %>
                <div class="task-item task-item--disabled">
                  <div class="task-item__icon task-item__icon--feedback">
                    <i class="fas fa-comments"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title"><%= t('dashboard.tasks.your_feedback') %></p>
                    <p class="task-item__subtitle"><%= t('dashboard.tasks.write_journal_first') %></p>
                  </div>
                  <div class="task-item__status task-item__status--locked">
                    <i class="fas fa-lock"></i>
                  </div>
                </div>
              <% end %>

              <!-- Partner's Conversation Status -->
              <% if @my_journal && @partner_journal %>
                <div class="task-item">
                  <div class="task-item__icon task-item__icon--conversation">
                    <i class="fas fa-microphone"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title"><%= t('dashboard.tasks.conversation') %></p>
                    <p class="task-item__subtitle"><%= @my_journal.conversation_status ? t('dashboard.tasks.completed_together') : t('dashboard.tasks.ready_to_practice') %></p>
                  </div>
                  <div class="task-item__status <%= @my_journal.conversation_status ? 'task-item__status--complete' : 'task-item__status--incomplete' %>">
                    <i class="fas <%= @my_journal.conversation_status ? 'fa-check-circle' : 'fa-hourglass-half' %>"></i>
                  </div>
                </div>
              <% else %>
                <div class="task-item task-item--disabled">
                  <div class="task-item__icon task-item__icon--conversation">
                    <i class="fas fa-microphone"></i>
                  </div>
                  <div class="task-item__content">
                    <p class="task-item__title"><%= t('dashboard.tasks.conversation') %></p>
                    <p class="task-item__subtitle"><%= t('dashboard.tasks.complete_journals_first') %></p>
                  </div>
                  <div class="task-item__status task-item__status--locked">
                    <i class="fas fa-lock"></i>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </section>


    <% else %>
      <!-- Welcome State (No Topic Selected) -->
      <section class="dashboard-section">
        <div class="welcome-card">
          <div class="welcome-card__logo">
            <i class="fas fa-language"></i>
          </div>
          <h2 class="welcome-card__title"><%= t('dashboard.welcome.title') %></h2>
          <p class="welcome-card__text"><%= t('dashboard.welcome.description') %></p>
          <%= link_to topics_path, class: "welcome-card__cta" do %>
            <i class="fas fa-rocket"></i>
            <%= t('dashboard.welcome.choose_topic') %>
          <% end %>
        </div>
      </section>
    <% end %>
  </main>
</div>
