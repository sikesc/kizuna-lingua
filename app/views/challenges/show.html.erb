<div style="height: calc(100vh - 56px); height: calc(100dvh - 56px); display: flex; flex-direction: column; background: #F8FAFC;"
     data-controller="timer"
     data-timer-user-language-value="<%= current_user.native_language.capitalize %>"
     data-timer-partner-language-value="<%= current_user.learning_language.capitalize %>">
  <!-- Header Section -->
  <header style="background: linear-gradient(135deg, #1E293B 0%, #475569 100%); padding: 1rem; flex-shrink: 0;">
    <div style="display: flex; align-items: center; gap: 0.75rem; max-width: 800px; margin: 0 auto;">
      <%= link_to topic_path(@topic), style: "display: flex; align-items: center; justify-content: center; width: 2.25rem; height: 2.25rem; background: rgba(255,255,255,0.1); border-radius: 50%; color: white; text-decoration: none; flex-shrink: 0;" do %>
        <i class="fas fa-arrow-left" style="font-size: 0.875rem;"></i>
      <% end %>
      <div style="flex: 1; min-width: 0;">
        <h1 style="font-size: 1.125rem; font-weight: 700; color: white; margin: 0; line-height: 1.2;"><%= @topic.name %></h1>
        <p style="font-size: 0.75rem; color: rgba(255,255,255,0.7); margin: 0.25rem 0 0 0;">Conversation Practice</p>
      </div>
    </div>
  </header>
  <!-- Main Content -->
  <main style="flex: 1; overflow-y: auto; padding: 1.5rem 1rem;">
    <div style="max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem;">
      <!-- Conversation Prompt Card -->
      <div style="background: white; border-radius: 1rem; box-shadow: 0 4px 16px rgba(30,41,59,0.08); overflow: hidden;">
        <div style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%); padding: 0.75rem 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-comment-alt" style="font-size: 0.875rem; color: white;"></i>
          <span style="font-size: 0.8125rem; font-weight: 600; color: white;">Conversation Topic</span>
        </div>
        <div style="padding: 1.25rem; font-size: 1rem; line-height: 1.7; color: #334155;">
          <% if current_user.learning_language == "japanese" %>
            <%= @challenge.conversation["en"] %>
          <% elsif current_user.learning_language == "english" %>
            <%= @challenge.conversation["jp"] %>
          <% end %>
        </div>
        <div style="padding: 0.875rem 1.25rem; background: #F1F5F9; border-top: 1px solid #E2E8F0; display: flex; align-items: center; gap: 0.625rem;">
          <i class="fas fa-info-circle" style="font-size: 0.875rem; color: #64748B; flex-shrink: 0;"></i>
          <p style="margin: 0; font-size: 0.8125rem; color: #64748B; line-height: 1.5;">Press the start button to start the challenge and start recording your conversation. This way your conversation can be reviewed at a later time. The speaking language will change every 2 minutes. Check below the recorder for a hint!</p>
        </div>
      </div>
      <!-- Timer Card -->
      <div style="background: linear-gradient(135deg, #1E293B 0%, #475569 100%); border-radius: 1rem; box-shadow: 0 4px 16px rgba(30,41,59,0.15); overflow: hidden;">
        <!-- Turn Indicator Banner -->
        <div data-timer-target="turnIndicator" style="padding: 1rem 1.5rem; background: rgba(255,255,255,0.1); font-size: 1.25rem; font-weight: 600; color: white; text-align: center;">
          Start Conversation in <%= current_user.learning_language.capitalize %>
        </div>
        <!-- Hidden Timer Display (keeps functionality) -->
        <div data-timer-target="display" style="display: none;"></div>
        <!-- Controls Section -->
        <div style="padding: 1.5rem;" data-controller="record" data-record-journal-value="<%= @journal.id %>">
          <!-- Recording Controls -->
          <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
            <button data-record-target="record" data-action="click->record#startRecording click->timer#startTimer" data-timer-target="startButton" class="recording-btn">
              <i class="fa-solid fa-pause d-none" data-timer-target="pauseIcon" style="font-size: 1.5rem;"></i>
              <i class="fa-solid fa-play" data-timer-target="playIcon" style="font-size: 1.5rem; margin-left: 3px;"></i>
            </button>
            <button data-action="click->record#stopRecording click->timer#stopTimer"
              style="display: flex; align-items: center; justify-content: center; width: 4rem; height: 4rem; background: linear-gradient(135deg, #EF4444 0%, #F87171 100%); border: none; border-radius: 50%; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(239,68,68,0.4); transition: transform 0.2s ease, box-shadow 0.2s ease;">
              <i class="fa-solid fa-stop" style="font-size: 1.5rem;"></i>
            </button>
            <!-- Recording Indicator (styled as a button) -->
            <div data-timer-target="recordingIndicator" style="display: none; align-items: center; justify-content: center; width: 4rem; height: 4rem; background: rgba(255,255,255,0.15); border: 2px solid rgba(239,68,68,0.6); border-radius: 50%; box-shadow: 0 4px 12px rgba(239,68,68,0.3);">
              <span class="recording-dot" style="width: 1rem; height: 1rem;"></span>
            </div>
          </div>
          <!-- Switch Language Button -->
          <div style="display: flex; justify-content: center;">
            <button data-action="click->timer#manualSwitch"
              style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 2rem; color: white; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background 0.2s ease;">
              <i class="fas fa-exchange-alt" style="font-size: 0.75rem;"></i>
              Switch Language
            </button>
          </div>
        </div>
      </div>
      <!-- Grammar Hints Accordion -->
      <div style="background: white; border-radius: 1rem; box-shadow: 0 4px 16px rgba(30,41,59,0.08); overflow: hidden;">
        <button type="button" data-bs-toggle="collapse" data-bs-target="#hintCollapse" aria-expanded="false" aria-controls="hintCollapse"
                style="width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; background: white; border: none; cursor: pointer;">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: linear-gradient(135deg, #FFB347 0%, #FFC66D 100%); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-lightbulb" style="font-size: 1rem; color: white;"></i>
            </div>
            <div style="text-align: left;">
              <div style="font-size: 0.9375rem; font-weight: 600; color: #1E293B;">Need a Hint?</div>
              <div style="font-size: 0.75rem; color: #64748B;">View grammar points for this conversation</div>
            </div>
          </div>
          <i class="fas fa-chevron-down" style="font-size: 0.75rem; color: #94A3B8; transition: transform 0.2s ease;"></i>
        </button>
        <div id="hintCollapse" class="accordion-collapse collapse" aria-labelledby="hintHeading">
          <div style="padding: 0 1.25rem 1.25rem; border-top: 1px solid #E2E8F0;">
            <% @grammar_points.each_with_index do |grammar_point, index| %>
              <div style="padding: 1rem 0; <%= 'border-bottom: 1px solid #E2E8F0;' unless grammar_point == @grammar_points.last %>">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <h5 style="font-size: 1rem; font-weight: 600; color: #1E293B; margin: 0;"><%= grammar_point.title %></h5>
                </div>
                <p style="font-size: 0.875rem; color: #475569; margin: 0 0 0.5rem 0; line-height: 1.6;">
                  <strong style="color: #1E293B;">Explanation:</strong> <%= grammar_point.explanation %>
                </p>
                <p style="font-size: 0.875rem; color: #475569; margin: 0; line-height: 1.6;">
                  <strong style="color: #1E293B;">Examples:</strong> <%= grammar_point.examples %>
                </p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

    </div>
  </main>
  <!-- Footer with Completion Button -->
  <footer style="flex-shrink: 0; background: white; padding: 1rem 1.5rem; border-top: 1px solid #E2E8F0; box-shadow: 0 -4px 16px rgba(30,41,59,0.05);">
    <div style="max-width: 800px; margin: 0 auto; display: flex; justify-content: center;">
      <%= button_to complete_conversation_journal_path(@journal),
                    method: :patch,
                    id: 'completion-form-button',
                    style: "display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 1rem 2rem; background: linear-gradient(135deg, #20B2AA 0%, #3CCDC5 100%); border: none; border-radius: 0.75rem; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(32,178,170,0.3); transition: transform 0.2s ease, box-shadow 0.2s ease; width: 100%; max-width: 400px;" do %>
        <i class="fas fa-check-circle"></i>
        <span>Conversation Completed</span>
      <% end %>
    </div>
  </footer>
</div>
